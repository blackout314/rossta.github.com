<!doctype html>
<html>
  <head>
    <title>Ruby, You Autocomplete Me | Ross Kaffenberger</title>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="The homepage of Ross Kaffenberger.">
    <meta name="keywords" content="Ross Kaffenberger, software, software developer,
    ruby, javascript, web development, startups">
    <script type="text/javascript" src="//use.typekit.net/ned0mml.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    <link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/images/favicon.ico" rel="icon" type="image/ico" />
  </head>
  <body id="application" class="typekit">
    <nav id="welcome" class="row">
      <section id="title" class="large-6 small-12 columns">
        <header class="signature-font">
          <h1><a class="logo" href="/">ross kaffenberger</a></h1>
        </header>
      </section>
      <section id="nav" class="large-6 small-12 columns nav">
        <ul>
  <li><a href="/projects">projects</a></li>
  <li><a href="/blog">blog</a></li>
  <li><a href="/about">about</a></li>
  <li><a href="/feed.xml">feed</a></li>
</ul>

      </section>
    </nav>
    <div id="neck">
      <div class="row">
        <div class="large-12 columns">I write about things</div>
      </div>
    </div>
    <div class="row">
      <section id="main" role="main" class="large-8 small-12 columns">
          
  
  <section id="blog">
    <article class="post">
      <header>
        <h2>
          Ruby, You Autocomplete Me
          <br /><small>Feb  5</small>
        </h2>
        
          <section class="share">
  <!-- AddThis Button BEGIN -->
  <div class="addthis_toolbox addthis_default_style" addthis:url="http://rosskaff.com/blog/2014/02/ruby,-you-autocomplete-me.html" addthis:title="Ruby, You Autocomplete Me">
    <a class="addthis_button_preferred_1"></a>
    <a class="addthis_button_preferred_2"></a>
    <a class="addthis_button_preferred_3"></a>
    <a class="addthis_button_preferred_4"></a>
    <a class="addthis_button_compact"></a>
    <a class="addthis_counter addthis_bubble_style"></a>
  </div>
  <script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-52f3af16161832f9"></script>
  <!-- AddThis Button END -->  
</section>

        
      </header>
      <p>My team recently added a tagging feature to our web app. As the user types in
the text input, the app supplies autocomplete suggestions from our database via
javascript; a familiar UX. While backporting tags to existing records on the
<code>rails console</code>, it hit me: &ldquo;Why not bring tag autocompletion to the command
line?&rdquo;</p>

<p>The default <code>rails console</code> provides completion out-of-the-box though all the script
does is start <code>irb</code> with the rails environment and <code>irb/completion</code> required.</p>

<pre><code class="ruby">#!/usr/bin/env ruby
require File.expand_path(&#39;../../load_paths&#39;, __FILE__)
require &#39;rails/all&#39;
require &#39;active_support/all&#39;
require &#39;irb&#39;
require &#39;irb/completion&#39;
IRB.start

# from https://github.com/rails/rails/blob/master/tools/console
</code></pre>

<p>Turns out that all <code>irb/completion</code> does is configure the ruby interface to the
<a href="http://cnswww.cns.cwru.edu/php/chet/readline/rltop.html">GNU Readline Library</a>.
This is done with the ruby <a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/readline/rdoc/Readline.html">Readline</a>
module. <code>Readline</code> accepts a <code>proc</code> that determines completion behavior by returning an array of string
candidates given an input string triggered, typically, by pressing <code>TAB</code>.</p>

<p>From <code>irb/completion</code>:</p>

<pre><code class="ruby">if Readline.respond_to?(&quot;basic_word_break_characters=&quot;)
#  Readline.basic_word_break_characters= &quot; \t\n\&quot;\\&#39;`&gt;&lt;=;|&amp;{(&quot;
  Readline.basic_word_break_characters= &quot; \t\n`&gt;&lt;=;|&amp;{(&quot;
end
Readline.completion_append_character = nil
Readline.completion_proc = IRB::InputCompletor::CompletionProc
</code></pre>

<p><code>IRB::InputCompletor::CompletionProc</code> is a proc that evaluates a large case
statement of regular expressions that attempt to determine the type of given
object and provide a set of candidates to match, such as <code>String</code> instance methods when
the input matches <code>$r{^(([&quot;&#39;]).*\2)\.([^.]*)$}</code>.</p>

<p>To give <code>Readline</code> a spin, fire up <code>irb</code> and paste in the following example, borrowed
from the <a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/readline/rdoc/Readline.html">ruby docs</a>:</p>

<pre><code class="ruby">require &#39;readline&#39;

LIST = [
  &#39;search&#39;, &#39;download&#39;, &#39;open&#39;,
  &#39;help&#39;, &#39;history&#39;, &#39;quit&#39;,
  &#39;url&#39;, &#39;next&#39;, &#39;clear&#39;,
  &#39;prev&#39;, &#39;past&#39;
].sort

comp = proc { |s| LIST.grep(/^#{Regexp.escape(s)}/) }

Readline.completion_append_character = &quot; &quot;
Readline.completion_proc = comp
</code></pre>

<p>There&#39;s nothing stopping us from taking this to the <code>rails console</code> to take
advantage of our rails environment and even access the database. Building off
the example, we can replace the hard-coded array with a list of tags plucked
from a simple activerecord query:</p>

<pre><code class="ruby">require &#39;readline&#39;

comp = proc { |s| ActsAsTaggableOn::Tag.named_like(s).pluck(:name) }

Readline.completion_proc = comp
</code></pre>

<p>We have room for improvement. For one thing, this makes a new query every time
you attempt to autocomplete. For a reasonable number of tags, we could load the
tag list in memory and grep for the matches instead. There is still another problem;
by replacing the <code>Readline.completion_proc</code>, we&#39;ve clobbered the functionality
provided by <code>irb/completion</code>. One approach would be to fall back to the
<code>IRB::InputCompletor::CompletionProc</code> or add its result to the array of candidates.
Given IRB has documented, <a href="https://github.com/cldwalker/bond#irbs-incorrect-completions">incorrect completions</a>
(try completing methods on a proc) and no built-in support for extending completion behavior,
this could get messy.</p>

<p>Enter <a href="https://github.com/cldwalker/bond">bond</a>, a drop-in replacement for IRB
completion. It aims to improve on IRB&#39;s shortcomings and provides methods for
adding custom completions. To take advantage of Bond in the console:</p>

<pre><code class="ruby">require &#39;bond&#39;
Bond.start
</code></pre>

<p>Bond allows you to extend the strategies for autocompleting text with <a href="https://github.com/cldwalker/bond/blob/master/lib/bond.rb#L21">the
<code>Bond.completion</code> method</a>.
To set up a Bond completion, we need a condition and an action; when the condition is matched,
then the given action will determine which candidates are returned. Calling
<code>Bond.start</code> will register Bond&#39;s default completions. For example, the
following completion is triggered with the text for completion starts with a
letter preceded by &ldquo;::&rdquo;; the search space is scoped to <code>Object.constants</code>.</p>

<pre><code class="ruby"># https://github.com/cldwalker/bond/blob/master/lib/bond/completion.rb#L13
complete(:prefix=&gt;&#39;::&#39;, :anywhere=&gt;&#39;[A-Z][^:\.\(]*&#39;) {|e| Object.constants }
</code></pre>

<p>To add tag autocompletion whenever we start a new string, we could use the following:</p>

<pre><code class="ruby">include Bond::Search # provides methods to search lists

TAG_NAMES = ActsAsTaggableOn::Tag.pluck(:name) # load tag names in memory

Bond.complete(:name=&gt;:tags, prefix: &#39;&quot;&#39;, :anywhere=&gt;&#39;([A-Z][^,]*)&#39;) {|e|
  tag = e.matched[2]
  normal_search(tag, TAG_NAMES)
}
</code></pre>

<p>Boom! Now we when autocomplete with some text inside an open double-quote, matching
tags from the database appear on the console.</p>

<pre><code>irb(main)&gt; &quot;Face[TAB]
Face++                     Facebook Graph             FaceCash
Face.com                   Facebook Graph API         FaceDetection
Facebook                   Facebook Opengraph         Facelets
Facebook Ads               Facebook Real-time Updates Faces.com
Facebook Chat              Facebook SDK               Facetly
Facebook Credits           Facebook Social Plugins
irb(main)&gt; &quot;Facebook&quot;, &quot;Twit[TAB]
Twitcher          TwitLonger        Twitter           Twitter Streaming Twitxr
TwitchTV          TwitPic           Twitter API       TwitterBrite
TwitDoc           TwitrPix          Twitter Bootstrap TwitterCounter
Twitgoo           Twitscoop         Twitter Grader    Twittervision
Twitlbl           TwitSprout        Twitter Oauth     Twitvid
</code></pre>

<p>Even though we ended up leveraging an existing gem, digging into the
Ruby standard library source code proved to be a useful exercise, revealing some
simple ways to hook into features easily taken for granted.</p>

    </article>
    
    <section class="comments">
      <section class="share">
  <!-- AddThis Button BEGIN -->
  <div class="addthis_toolbox addthis_default_style" addthis:url="http://rosskaff.com/blog/2014/02/ruby,-you-autocomplete-me.html" addthis:title="Ruby, You Autocomplete Me">
    <a class="addthis_button_preferred_1"></a>
    <a class="addthis_button_preferred_2"></a>
    <a class="addthis_button_preferred_3"></a>
    <a class="addthis_button_preferred_4"></a>
    <a class="addthis_button_compact"></a>
    <a class="addthis_counter addthis_bubble_style"></a>
  </div>
  <script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-52f3af16161832f9"></script>
  <!-- AddThis Button END -->  
</section>

      <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname  = 'rosskaff';
    var disqus_identifier = 'ruby,-you-autocomplete-me';
    var disqus_title      = 'Ruby, You Autocomplete Me';
    var disqus_url        = 'http://rosskaff.com/blog/2014/02/ruby,-you-autocomplete-me.html';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<!-- <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> -->

    </section>
    
  </section>

      </section>
      <section id="sidebar" role="sidebar" class="large-4 small-12 columns">
        <a href="https://twitter.com/rossta" class="twitter-follow-button" data-show-count="true">Follow @rossta</a>

<script>
!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
</script>
<section id="extras">
  <aside>
    <h6>Recent Articles</h6>
    <ul>
      
        <li>
          <a href="/blog/2014/02/ruby,-you-autocomplete-me.html">Ruby, You Autocomplete Me</a>
        </li>
      
        <li>
          <a href="/blog/2014/02/automatic-backups-to-amazon-s3-are-easy.html">Automatic Backups to Amazon S3 are Easy</a>
        </li>
      
        <li>
          <a href="/blog/2013/08/featured-post-for-speed-awareness-month.html">Featured Post for Speed Awareness Month</a>
        </li>
      
        <li>
          <a href="/blog/2013/03/configuring-rack-test-driver-in-capybara-2.html">Configuring Rack Test Driver in Capybara 2</a>
        </li>
      
        <li>
          <a href="/blog/2013/03/why-i-ditched-wordpress-for-github.html">Why I Ditched Wordpress for Github</a>
        </li>
      
    </ul>

    <h6>Tags</h6>
    <ul>
      
        <li><a href="/blog/tags/life.html">Life [4]</a></li>
      
        <li><a href="/blog/tags/code.html">Code [17]</a></li>
      
        <li><a href="/blog/tags/work.html">Work [1]</a></li>
      
    </ul>

    <h6>By Year</h6>
    <ul>
      
        <li><a href="/blog/2014.html">2014 [2]</a></li>
      
        <li><a href="/blog/2013.html">2013 [4]</a></li>
      
        <li><a href="/blog/2012.html">2012 [1]</a></li>
      
        <li><a href="/blog/2011.html">2011 [5]</a></li>
      
        <li><a href="/blog/2010.html">2010 [7]</a></li>
      
    </ul>
  </aside>

</section>

      </section>
    </div>
    <div class="row">
      <footer>
        <section class="large-12 columns center-inline-list">
          <ul class="inline-list">
  <li><a href="mailto:rosskaff@gmail.com">email</a></li>
  <li><a href="http://twitter.com/rossta">twitter</a></li>
  <li><a href="http://github.com/rossta">github</a></li>
</ul>

        </section>
      </footer>
    </div>
    <script src="/javascripts/all.js" type="text/javascript"></script>
    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-16458563-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

    <!--[if !(lt IE 8)]><!-->
   <script type="text/javascript">
     (function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src=document.location.protocol+"//d1agz031tafz8n.cloudfront.net/thedaywefightback.js/widget.min.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
   </script>
<!--<![endif]-->
  </body>
</html>
