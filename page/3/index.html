<!doctype html>
<html>
  <head>
    <title>Home | Ross Kaffenberger</title>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="The homepage of Ross Kaffenberger.">
    <meta name="keywords" content="Ross Kaffenberger, software, software developer,
    ruby, javascript, web development, startups">
    <script type="text/javascript" src="//use.typekit.net/ned0mml.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    <link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/images/favicon.ico" rel="icon" type="image/ico" />
  </head>
  <body id="application" class="typekit">
    <nav id="welcome" class="row">
      <section id="title" class="large-6 small-12 columns">
        <header class="signature-font">
          <h1><a class="logo" href="/">ross kaffenberger</a></h1>
        </header>
      </section>
      <section id="nav" class="large-6 small-12 columns nav">
        <ul>
  <li><a href="/projects">projects</a></li>
  <li><a href="/blog">blog</a></li>
  <li><a href="/about">about</a></li>
  <li><a href="/feed.xml">feed</a></li>
</ul>

      </section>
    </nav>
    <div id="neck">
      <div class="row">
        <div class="large-12 columns">I make things</div>
      </div>
    </div>
    <div class="row">
      <section id="main" role="main" class="large-8 small-12 columns">
          <article class="index-post">
    <h2>
      <a href="/blog/2010/12/behavior-driven-event-driven-eventmachine-rspec.html">How to Test Your Eventmachine Code with RSpec</a>
      <br />
      <small>Dec 27</small>
    </h2>
    <p>With all the hubbub around <a href="http://nodejs.org/">node.js</a> lately, it’s been easy to forget established event-driven server-side processing solutions in Ruby. One option is <a href="http://rubyeventmachine.com/">eventmachine</a>, which I recently used to develop a multi-player online sudoku game, <a href="http://playsudokill.com">Sudokill</a>, for my Heuristics class at NYU.</p>

<p>As the game designer, I needed to build a game server that could easily handle multiple socket connections to player programs written by my classmates. Leveraging the event-driven nature of eventmachine, I was able to build a server that is fast, efficient and easy to maintain.</p>

<p>A commonly-cited drawback to event-driven programming is that it’s hard. For starters, we can easily wrap our heads around a procedural approach to a server connecting to a client:
</p>

<p>Server waits for client 1
Client attempts to connect to server
Server accepts connection with client 1
Server tells client 1 to wait
Now server waits for client 2
Repeat as before and so on&hellip;</p>

<p></p>

<p>This pattern is familiar: like a cookbook recipe or instructions for building a model airplane, we are well-equpped to handle things one step at a time. With the event model, we think in terms of discrete behaviors instead of ordered steps. We need to identify important events and their responses:</p>

<p></p>

<p>Whenever a socket connection is received, say hello
Whenever a message through a socket connection, process it
Whenever a socket connection disconnects, say goodbye</p>

<p></p>

<p>This model is common for front-end development (e.g. onclick, onmousever, etc.), but the notion of attaching events is not restricted to writing javascript for the DOM. Eventmachine provides some out-of-box hooks for adding behavior to expected events, like accepting socket connections. It also provides methods for defining and triggering our own custom behaviors.</p>

<p>Speaking of behavior: what about behavior-driven development with eventmachine? Absorbing the conceptual leap to programming to events is one challenge, and now, the mechanics of writing tests for them present another.</p>

<p>Let’s consider how we would test a client player connecting to my game server through a socket. I’ll build a class called Server which will be responsible for starting the eventmachine when its #start method is called. When a socket connection is made, I want to add the new player to a list of players kept on the server and send the message “READY” back to the client.</p>

<p>How would we write an integration test for this with rspec? The test would have to start an instance of my server class and separately initiate a client socket connection. Once the connection is made, then the test assertions can be run. After some digging around, I found some good examples to follow in the Ilya Grigorik’s eventmachine-backed websocket server, <a href="https://github.com/igrigorik/em-websocket">em-websocket</a>. Here’s the basic approach:</p>

<p>An eventmachine process runs in a loop: once we start the loop, it will run forever until we trigger the event to stop the loop. All of our eventmachine code will happen in the event loop. We setup the loop by passing our code in a block to the <a href="http://eventmachine.rubyforge.org/EventMachine.html#M000461">run</a> method:</p>

<p>So in our test, we’ll create the event loop with EM.run and pass a block with our test code in which we can start the game server and the socket connection. Once the assertions have been made, we’ll call EM.stop to end the event loop. Otherwise, it would run forever; we’d never get to the next test!</p>

<p>An eventmachine socket server can be initiated with the <a href="http://eventmachine.rubyforge.org/EventMachine.html#M000470">start_server</a> method. We’ll give this method a host and port where it will listen for clients.</p>

<p>We’ll also use eventmachine’s <a href="http://eventmachine.rubyforge.org/EventMachine.html#M000473">connect</a> method to make the client socket connection to the server. When a socket connection is made, eventmachine creates an instance of EventMachine::Connection which responds to certain methods representing different phases of the socket connection: after initialization, when a message is received, when the connection is broken, etc. EM.connect accepts a module or class inheriting from EventMachine::Connection which allows us to mix in our app or test logic to the connection.</p>

<p>To take the place of a player client in the test, I’ve borrowed FakeSocketClient (which subclasses EventMachine::Connection) from the em-websocket test suite and defined it in my spec_helper.rb. The fake client exposes attr_accessors onopen, omessage and onclose that we’ll treat like callbacks in the test.</p>

<p>We’ll assign a proc to the #onopen callback in FakeSocketClient. This proc will be triggered the first time the client socket receives a message. Since we want to the server to send a message when the connection is established, we expect this message to be “READY”. In addition, we’ll assert that there is one player added to the server’s list of players. Then we stop the event machine.</p>

<p>The key for making our rspec assertions: the socket connection between the server and client is accepted after the rest of the code in the EM.run block has been called. The instance FakeSocketClient receives #initialize and #post_init when EM.connect is called, but then the context returns to our test: we can now assign procs to FakeSocketClient’s onopen, onmessage and onclose callbacks as needed.</p>

<p>The #start method of our server is straightforward. It must start its own event loop and call EM.start_server previously discussed:</p>

<p>Other tests may include multiple client connections where we may need to assert that different messages like “YOUR TURN” and “WAIT YOUR TURN” are sent to the correct players.</p>

<p>For more reading on the subject of event programming, I recommend <a href="http://pdos.csail.mit.edu/~rtm/papers/dabek:event.pdf">Dabek, et.al, Event-driven Programming for Robust Software</a>.</p>

    <div class="comments">
      <a href="/blog/2010/12/behavior-driven-event-driven-eventmachine-rspec.html#disqus_thread">Comments</a>
    </div>
  </article>
  <article class="index-post">
    <h2>
      <a href="/blog/2010/12/heuristics.html">Heuristics</a>
      <br />
      <small>Dec 25</small>
    </h2>
    <p>I just completed another semester of grad school at NYU. Progress towards my computer science degree has been slow: this is my fourth year in the program. As a part-time student, one class at a time is all I can handle. This time, the course was <a href="http://cs.nyu.edu/courses/fall10/G22.2965-001/index.html">Heuristics</a>, which by itself was more than almost anyone can handle.</p>

<p>At its core, the course is about solving puzzles. What is the shortest route that passes through all the cities (<a href="http://cs.nyu.edu/courses/fall10/G22.2965-001/travelingsalesman.html">Traveling Salesman</a>)? How many injured people around the city can you pick up in your ambulances in time (<a href="http://cs.nyu.edu/courses/fall10/G22.2965-001/ambulance.html">Ambulance Planning</a>)? What strategy is best for winning more area than your opponents (<a href="http://cs.nyu.edu/courses/fall10/G22.2965-001/voronoi.html">Voronoi</a>)? Who’s the best match across these 30 personality traits (Dating Game)?</p>

<p>Most of these problems fall into the category called NP-hard, which may be roughly defined as the class of problems that are at least as hard as those that can be solved in non-deterministic polynomial time. The more useful way for us to think about the general definition is to say that there is a verifiable best answer to the problem, but it would be very difficult, perhaps impossible, to design a general approach that would find this solution quickly.</p>

<p>Our goal for each problem then was to apply an appropriate set of heuristics: strategies to estimate a solution that would come as close as possible to the best solution in a reasonable amount of time. Two minutes in fact. Every week then, we had write a program to solve a NP-hard problem in competition with our classmates. If the program didn’t run, we lost. If it went over the two minute time limit, we lost.</p>

<p>Most problems involved interacting with a server via sockets. One student was chosen as the “architect” each week. Instead of solving the problem, the architect created an interface and protocol for communicating with the player clients, and a GUI to display the game progress and results. Extra pressure came with this role: if the server didn’t work or if player clients had difficulty connecting, the competition would be a failure. I chose to be the architect for the final game of the semester, <a href="http://cs.nyu.edu/courses/fall10/G22.2965-001/sudokill.html">Sudokill</a>, a form of competitive Sudoku. I plan to write more about Sudokill in the near future.</p>

<p>By far, this course was the most difficult class I’ve taken in grad school, both conceptually and regarding the workload. At its peak, I spent 30-40 hours a week preparing for the Monday competition. This was often time spent in the early morning hours before and after work. By the end of the semester, fewer than 50% of students were completing their assignments on time. Despite the burden on my free time, this was also the most fun and rewarding class I’ve ever taken. It certainly helped that I was allowed to write my programs in Ruby; this is a rare opportunity in department where most of the faculty prefers Java and C .</p>

<p>I’ve posted my class solutions in a single project on github:</p>

<p>My code for the Sudokill game server:</p>

<p>Check out the game too:
<a href="http://rosskaff.github.com/sudokill/">http://rosskaff.github.com/sudokill</a>
<a href="http://cs.nyu.edu/courses/fall10/G22.2965-001/sudokill.html">Game rules</a></p>

    <div class="comments">
      <a href="/blog/2010/12/heuristics.html#disqus_thread">Comments</a>
    </div>
  </article>
  <article class="index-post">
    <h2>
      <a href="/blog/2010/09/step-up-to-the-soapbox.html">Step up to the soapbox</a>
      <br />
      <small>Sep  8</small>
    </h2>
    <p>Recently, I cobbled together an entry for the <a href="http://10k.aneventapart.com/">10K Apart Contest</a>. The contest encouraged participants to build an entirely front-end web application in HTML/CSS/Javascript in under 10 kb of total assets, not including some allowable third party libraries such as jQuery or Prototype. Entries must also leverage HTML5 features, some of which include local storage, the canvas API, and web workers.</p>

<p>Several entries had already been submitted by the time I heard of the contest back in mid-July. I found games, like <a href="http://10k.aneventapart.com/Entry/62">Lines</a>, search engines, to-do lists, and so on. I considered implementing a Flickr slideshow that would make use of the contributions I’ve made to the <a href="http://github.com/weplay/supersized">supersized</a> jQuery plugin at Weplay, but ultimately decided on a Keynote/Powerpoint alternative.</p>

<p>It’s called soapbox. The inspiration comes from <a href="http://github.com/schacon/showoff">showoff</a>, which is backed by a server. soapbox provides an in-browser interface to create, preview and present slides with <a href="http://daringfireball.net/projects/markdown/">markdown</a> or markup. Slides are auto-saved to local storage, if available, as json. I sent in <a href="http://10k.aneventapart.com/Entry/361">my 10K Apart entry</a> on the deadline day. You can also find the latest on <a href="http://github.com/rosskaff/soapbox">github</a>.</p>

    <div class="comments">
      <a href="/blog/2010/09/step-up-to-the-soapbox.html#disqus_thread">Comments</a>
    </div>
  </article>
  <article class="index-post">
    <h2>
      <a href="/blog/2010/07/delegate-and-custom-events.html">$.delegate and Custom Events</a>
      <br />
      <small>Jul 20</small>
    </h2>
    <p>Sharing team photos and video is central to <a href="http://www.weplay.com">Weplay</a> and my team has been working hard recently to make some dramatic improvements to the media gallery experience.</p>

<p>One area in dire need of attention was the ability to edit photo metadata easily: changing captions, deleting pictures, moving from one album to another, etc. A user was forced to submit changes for up to sixty photos at a time with one post request. The response was slow and the potential for losing lots of changes was unacceptable.</p>

<p>We committed to swapping this experience with a more user-friendly ajaxified set of interactions. Each change is saved as you go and the updates take place in line. A key component of our front-end javascript is use of <a href="http://jquery.com/">jQuery</a>‘s <code>$.delegate</code>, available as of jQuery 1.4.2, and custom events.</p>

<p>I put together a brown bag presentation for my team explaining the benefits of $.delegate and custom events, currently available at .</p>

<p>The slides are written in markdown and presented using Scott Chacon’s excellent <a href="http://github.com/schacon/showoff">showoff</a>, which allows the embedding of printed, executable javascript. Note: since showoff ships with jQuery 1.4.0, the <code>$.delegate</code> examples are not currently executable.</p>

    <div class="comments">
      <a href="/blog/2010/07/delegate-and-custom-events.html#disqus_thread">Comments</a>
    </div>
  </article>
  <article class="index-post">
    <h2>
      <a href="/blog/2010/05/mott-hall-iii-school-career-day.html">Mott Hall III School Career Day</a>
      <br />
      <small>May 17</small>
    </h2>
    <p>As Calvin was leaving the classroom, he turned back toward me with a smile and a glint in his eye. That was all I needed to see to know: the lesson had made an impression. As a teacher, nothing beats that feeling. I could sense he wanted to say something; he was looking for the right words. He then told me about a website he knew of where he wanted to try more on his own.</p>

<p>A friend at the <a href="http://schools.nyc.gov/SchoolPortals/09/X128/default.htm">Mott Hall III in the Bronx</a> invited me to speak at the school’s career day this past Friday. I may have been slow to respond, but as a former teacher myself, I knew this was one opportunity I could not pass up.</p>

<p>Mott Hall III is a not a typical public school school. At some 320 students in grades 6 through 8, it’s small. Students are admitted by application. There is an air of curiosity and respect that accompanies a school where students are held to high expectations.</p>

<p>I was one of about twenty speakers to speak with four groups of students for 30 minutes at a time. I wasn’t sure how to present until I learned I was offered the computer lab. I couldn’t resist: I would have students write a computer program.</p>

<p>Having left myself only a day to put something together, I decided it would be easiest for students to access a web page with a javascript console where we could walk through a few commands. Visual feedback would be key. There are some great in browser javascript consoles that came to mind: <a href="http://www.jconsole.com/">jconsole</a> comes to mind. But the console needed a visual aspect&emdash;something to manipulate and see results. As I had done for many lessons as a teacher for years, I decided to roll my own.</p>

<p>The <a href="http://www.rosskaff.com/wp-content/uploads/2010/05/playground.html">Javascript Playground</a> was born. Dirt simple, but effective for a short lesson, it is intended to be a lightweight introduction to using javascript. For career day, my aim was simply to have the students dip their toes in the process. Maybe experience a setback and (hopefully) find success. They would enter middle school students and leave computer programmers.</p>

<p>I put together a Keynote presentation to introduce the lesson and help students see why software engineers and computer programmers were relevant as builders of software for familiar technology like iPhone Apps, Facebook and Twitter. A segment I called “Computers are Dumb”, (common responses: Wha’? and Huh?) was inspired by my colleague <a href="http://boxornot.com/2008/07/21/how-i-became-a-programmer/">Noah Davis</a>, who had done something similar for his own career day talk. I pretended to be a walking, listening computer who needed instructions to get around desks from one side of the room to the next. I let students shout out instructions which initially led to some comical results. “Turn right” resulted in my spinning in an endless loop and “Walk straight” usually ended with me walking into a wall or chair. The point: computers will do exactly what we tell them to do, not always what we <em>think</em> we’re telling them to do. This was important prelude to the playground.</p>

<p>We then turned our attention to the computers. Once I had led them to the playground and introduced a few commands, within minutes, they were hiding, showing, fading, and moving “Player 1″, a 50×50 pixel image of me. To keep things simple, I made <a href="http://jquery.com/">jQuery</a> available and loaded the console textarea with the player one selector prefilled: <code>$(&quot;#player1&quot;)</code></p>

<p>I would demonstrate a command like</p>

<p><code>$(&quot;#player1&quot;).hide()</code></p>

<p>or</p>

<p><code>$(&quot;#player1&quot;).fadeOut()</code></p>

<p>and many students were quick to discover the complements: <code>.show()</code> and <code>.fadeIn()</code>. The real challenge for the ten minute lesson was to <em>move</em> player 1 from one corner of the screen to the “Home” area.</p>

<p>I could have used the <code>.animate()</code> function with options for manipulating <code>top</code> and <code>left</code> properties, but to simplify things, I wrote a more literal plugin <code>$.fn.move(x, y)</code> as a wrapper around <code>animate</code>. The <code>move</code> command simple takes x and y coordinates as paramaters&emdash;something I could tell was familiar for them from their math classes. While <code>move</code> added the x and y values to their current position, <code>$.fn.goto(x, y)</code> was introduced to jump directly to a place on (or off) the screen. It wasn’t long before the experimentation had begun. A few students figured out how to run multiple commands at once, some even used chained commands on their own: <code>$(&quot;#player1&quot;).fadeOut().fadeIn()</code>. Students were soon signaling me to show how they had led player 1 home.</p>

<p>At each of the sessions, I never seemed to leave enough time for questions. I encouraged students to return to this blog to post comments. I hope I was able to make computer programming a little more accessible and enjoyable for these motivated students in the Bronx. I may have even caught a bit of the teaching bug again myself.</p>

    <div class="comments">
      <a href="/blog/2010/05/mott-hall-iii-school-career-day.html#disqus_thread">Comments</a>
    </div>
  </article>

  <p>Page 3 of 4</p>
  
    <p><a href="/page/4/">Next page</a></p>
  
  
    <p><a href="/page/2/">Previous page</a></p>
  

<section>
  <a href="/blog">See all posts &raquo;</a>
</section>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'rosskaff'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>

      </section>
      <section id="sidebar" role="sidebar" class="large-4 small-12 columns">
        <section id="extras">
  <aside>
    <h6>Recent Articles</h6>
    <ul>
      
        <li>
          <a href="/blog/2014/02/automatic-backups-to-amazon-s3-are-easy.html">Automatic Backups to Amazon S3 are Easy</a>
        </li>
      
        <li>
          <a href="/blog/2013/03/configuring-rack-test-driver-in-capybara-2.html">Configuring Rack Test Driver in Capybara 2</a>
        </li>
      
        <li>
          <a href="/blog/2013/03/why-i-ditched-wordpress-for-github.html">Why I Ditched Wordpress for Github</a>
        </li>
      
        <li>
          <a href="/blog/2013/03/create-and-deploy-an-ember-app-in-5-minutes.html">Create and Deploy an Ember App in 5 Minutes</a>
        </li>
      
        <li>
          <a href="/blog/2012/02/presentation-intro-to-javascript-mvc.html">Presentation Intro to Javascript MVC</a>
        </li>
      
    </ul>

    <h6>Tags</h6>
    <ul>
      
        <li><a href="/blog/tags/life.html">Life [4]</a></li>
      
        <li><a href="/blog/tags/code.html">Code [14]</a></li>
      
        <li><a href="/blog/tags/work.html">Work [1]</a></li>
      
    </ul>

    <h6>By Year</h6>
    <ul>
      
        <li><a href="/blog/2014.html">2014 [1]</a></li>
      
        <li><a href="/blog/2013.html">2013 [3]</a></li>
      
        <li><a href="/blog/2012.html">2012 [1]</a></li>
      
        <li><a href="/blog/2011.html">2011 [5]</a></li>
      
        <li><a href="/blog/2010.html">2010 [7]</a></li>
      
    </ul>
  </aside>

</section>

      </section>
    </div>
    <div class="row">
      <footer>
        <section class="large-12 columns center-inline-list">
          <ul class="inline-list">
  <li><a href="mailto:rosskaff@gmail.com">email</a></li>
  <li><a href="http://twitter.com/rossta">twitter</a></li>
  <li><a href="http://github.com/rossta">github</a></li>
</ul>

        </section>
      </footer>
    </div>
    <script src="/javascripts/all.js" type="text/javascript"></script>
    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-16458563-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </body>
</html>
